<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåå AstroPlan v4.2 ULTIMATE</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/png" href="icon-192.png">

    <style>
        :root {
            --bg: #05010b;
            --bg-alt: #0b0616;
            --accent: #7c4dff;
            --accent-soft: rgba(124,77,255,0.15);
            --text: #ffffff;
            --text-muted: #a0a0c0;
            --danger: #ff5252;
            --ok: #4caf50;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        body {
            background: radial-gradient(circle at top, #1a0936 0, #05010b 55%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 12px 16px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        header h1 span.logo {
            font-size: 1.4rem;
        }
        header small {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .chip {
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.7rem;
            border: 1px solid var(--accent);
            background: var(--accent-soft);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        main {
            padding: 4px 12px 72px;
        }
        .section-title {
            margin: 10px 4px 4px;
            font-size: 0.82rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .card {
            background: linear-gradient(135deg, rgba(24,18,66,0.95), rgba(10,3,30,0.98));
            border-radius: 14px;
            padding: 10px;
            border: 1px solid rgba(124,77,255,0.25);
            box-shadow: 0 8px 18px rgba(0,0,0,0.45);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .card-title {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .card-title span.emoji {
            font-size: 1rem;
        }
        .pill {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.06);
            color: var(--text-muted);
        }
        .highlight {
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .meta {
            font-size: 0.72rem;
            color: var(--text-muted);
        }
        .meta strong {
            color: var(--text);
        }

        .tabs {
            display: flex;
            margin: 10px 0 4px;
            background: rgba(10,3,30,0.9);
            border-radius: 999px;
            padding: 3px;
            border: 1px solid rgba(124,77,255,0.35);
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 6px 0;
            font-size: 0.75rem;
            border-radius: 999px;
            color: var(--text-muted);
        }
        .tab.active {
            background: var(--accent);
            color: #fff;
        }

        .panel {
            background: linear-gradient(135deg, rgba(14,7,40,0.98), rgba(5,2,20,0.98));
            border-radius: 16px;
            border: 1px solid rgba(124,77,255,0.4);
            padding: 10px;
            margin-bottom: 10px;
        }

        .field-label {
            font-size: 0.76rem;
            color: var(--text-muted);
            margin-bottom: 3px;
        }
        select, button, input[type="number"] {
            width: 100%;
            padding: 7px 9px;
            border-radius: 999px;
            border: 1px solid rgba(124,77,255,0.5);
            background: rgba(0,0,0,0.4);
            color: var(--text);
            font-size: 0.8rem;
            outline: none;
        }
        select:focus, input[type="number"]:focus {
            border-color: var(--accent);
        }
        .row {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }
        .col {
            flex: 1;
        }

        .params {
            font-size: 0.78rem;
            margin-top: 4px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 6px 8px;
        }
        .params strong {
            color: var(--accent);
        }

        .steps {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 6px;
        }
        .step {
            display: flex;
            gap: 6px;
            align-items: flex-start;
            font-size: 0.75rem;
        }
        .step-num {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        .step-text strong {
            display: block;
        }

        .camera-preview {
            width: 100%;
            border-radius: 12px;
            background: #000;
            aspect-ratio: 4/3;
            margin-top: 6px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .camera-overlay {
            position: absolute;
            inset: 0;
            border: 1px dashed rgba(255,255,255,0.4);
            border-radius: 12px;
            pointer-events: none;
        }
        .camera-status {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7c4dff, #b388ff);
            border: none;
            color: #fff;
            font-weight: 600;
        }
        .btn-secondary {
            background: rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.25);
        }

        .footer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 6px 10px;
            background: radial-gradient(circle at top, rgba(124,77,255,0.25), rgba(0,0,0,0.95));
            border-top: 1px solid rgba(124,77,255,0.4);
            display: flex;
            justify-content: space-between;
            gap: 6px;
        }
        .footer button {
            font-size: 0.8rem;
        }

        .badge-ok { color: var(--ok); font-size: 0.75rem; }
        .badge-bad { color: var(--danger); font-size: 0.75rem; }

        .toggle-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
            font-size: 0.75rem;
        }
        .toggle {
            width: 32px;
            height: 18px;
            border-radius: 999px;
            background: rgba(255,255,255,0.15);
            position: relative;
            cursor: pointer;
        }
        .toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #fff;
            transition: transform 0.2s ease;
        }
        .toggle.on {
            background: var(--accent);
        }
        .toggle.on .toggle-knob {
            transform: translateX(14px);
        }
    </style>
</head>
<body>
<header>
    <div>
        <h1><span class="logo">üåå</span>AstroPlan <small>v4.2</small></h1>
        <small>Asistente para tu Redmi Note 13 Pro 5G</small>
    </div>
    <div class="chip">
        üì∂ PWA &nbsp;|&nbsp; üì∑ C√°mara b√°sica
    </div>
</header>

<main>
    <p class="section-title">Inicio r√°pido</p>
    <div class="card-grid">
        <div class="card" id="cardTonight">
            <div class="card-header">
                <div class="card-title">
                    <span class="emoji">üåÉ</span>Esta noche
                </div>
                <span class="pill" id="skyQualityTag">Bortle 5 aprox.</span>
            </div>
            <div class="highlight" id="tonightSummary">
                Ventana V√≠a L√°ctea: 22:10‚Äì00:30 aprox.
            </div>
            <div class="meta">
                Luna: <strong id="moonInfo">38% / se pone 21:45</strong><br>
                Recomendaci√≥n: <span id="tonightTip">Cielo decente, usa ISO medio y varias tomas.</span>
            </div>
        </div>

        <div class="card" id="cardObject">
            <div class="card-header">
                <div class="card-title">
                    <span class="emoji">üéØ</span>Objeto objetivo
                </div>
                <span class="pill" id="objectTypeTag">Cielo profundo</span>
            </div>
            <div class="highlight" id="objectNameLabel">
                V√≠a L√°ctea central
            </div>
            <div class="meta">
                Mejor hora: <strong id="bestTimeLabel">23:15‚Äì01:00</strong><br>
                Altura: <span id="altitudeLabel">+45¬∞ S</span>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" id="tabPlan">Planificar</div>
        <div class="tab" id="tabCapture">Capturar</div>
        <div class="tab" id="tabSession">Sesi√≥n</div>
    </div>

    <!-- Panel Planificar -->
    <section class="panel" id="panelPlan">
        <div class="row">
            <div class="col">
                <div class="field-label">Ubicaci√≥n</div>
                <select id="locationSelect">
                    <option value="pereira" selected>Pereira (Risaralda, CO)</option>
                    <option value="cartago">Cartago (Valle, CO)</option>
                    <option value="obando">Obando (Valle, CO)</option>
                    <option value="juandiaz">Zona rural Juan D√≠az (Valle, CO)</option>
                    <option value="barcelona">Barcelona (Espa√±a)</option>
                    <option value="custom">Otra / personalizada</option>
                </select>
            </div>
            <div class="col">
                <div class="field-label">Nivel de cielo (Bortle)</div>
                <select id="bortleSelect">
                    <option value="3">3 (muy oscuro)</option>
                    <option value="4">4 (rural)</option>
                    <option value="5">5 (semi-rural)</option>
                    <option value="6">6 (periurbano)</option>
                    <option value="7">7 (urbano)</option>
                </select>
            </div>
        </div>

        <div class="field" style="margin-top:4px;">
            <div class="field-label">Objeto a fotografiar</div>
            <select id="objectSelect">
                <optgroup label="Cielo profundo">
                    <option value="milkyway" selected>V√≠a L√°ctea (paisaje)</option>
                    <option value="andromeda">Galaxia de Andr√≥meda (M31)</option>
                    <option value="orion">Nebulosa de Ori√≥n (M42)</option>
                    <option value="pleiades">Pl√©yades (M45)</option>
                </optgroup>
                <optgroup label="Sistema solar">
                    <option value="moon">Luna (detalles)</option>
                    <option value="moonWide">Luna (paisaje)</option>
                    <option value="jupiter">J√∫piter</option>
                    <option value="saturn">Saturno</option>
                    <option value="mars">Marte</option>
                </optgroup>
            </select>
        </div>

        <div class="row" style="margin-top:6px;">
            <div class="col">
                <div class="field-label">Tolerancia de trailing (%)</div>
                <input type="number" id="trailingInput" min="1" max="15" value="5">
            </div>
        </div>

        <div class="params" id="paramsBox">
            <div><strong>Par√°metros sugeridos para tu Redmi:</strong></div>
            <div id="paramsText">
                V√≠a L√°ctea ¬∑ ISO 1600‚Äì3200 ¬∑ 15‚Äì20 s ¬∑ f/1.65 (m√°xima apertura) ¬∑ 20‚Äì40 fotos para apilado.
            </div>
        </div>

        <div class="steps">
            <div class="step">
                <div class="step-num">1</div>
                <div class="step-text">
                    <strong>Preparar</strong>
                    <span id="step1Text">
                        Usa tr√≠pode, modo avi√≥n, brillo al m√≠nimo, enfoca a infinito con toque manual si tu app lo permite.
                    </span>
                </div>
            </div>
            <div class="step">
                <div class="step-num">2</div>
                <div class="step-text">
                    <strong>Encadrar</strong>
                    <span id="step2Text">
                        Apunta hacia el sur/se-suroeste donde la V√≠a L√°ctea est√© m√°s alta entre 22:00 y 01:00, evitando luces directas.
                    </span>
                </div>
            </div>
            <div class="step">
                <div class="step-num">3</div>
                <div class="step-text">
                    <strong>Disparar</strong>
                    <span id="step3Text">
                        Usa temporizador 3‚Äì5 s, dispara r√°fagas de 20‚Äì40 fotos con los mismos par√°metros para apilar luego.
                    </span>
                </div>
            </div>
        </div>

        <div class="toggle-line">
            <span>Modo luz roja (noche)</span>
            <div class="toggle" id="redModeToggle">
                <div class="toggle-knob"></div>
            </div>
        </div>
    </section>

    <!-- Panel Capturar -->
    <section class="panel" id="panelCapture" style="display:none;">
        <div class="field-label">Modo de captura</div>
        <select id="captureMode">
            <option value="guided" selected>Captura guiada (wizard)</option>
            <option value="preview">Solo previsualizar c√°mara</option>
        </select>

        <div class="camera-preview" id="cameraContainer">
            <video id="cameraVideo" autoplay playsinline></video>
            <div class="camera-overlay"></div>
        </div>
        <div class="camera-status" id="cameraStatus">
            Toca ‚ÄúIniciar c√°mara‚Äù para encuadrar tu objeto. La app no guarda fotos, solo ayuda a encuadrar.
        </div>

        <div class="params" style="margin-top:8px;">
            <div><strong>Recordatorio de par√°metros:</strong></div>
            <div id="paramsCaptureText">
                V√≠a L√°ctea ¬∑ Modo Pro en tu c√°mara ¬∑ ISO 1600‚Äì3200 ¬∑ 15‚Äì20 s ¬∑ enfoque manual a infinito.
            </div>
        </div>

        <div class="steps" style="margin-top:8px;">
            <div class="step">
                <div class="step-num">1</div>
                <div class="step-text">
                    <strong>Preparar tel√©fono</strong>
                    <span id="capStep1Text">
                        Coloca el Redmi en tr√≠pode, activa modo avi√≥n, desactiva brillo autom√°tico y limpia la lente trasera.
                    </span>
                </div>
            </div>
            <div class="step">
                <div class="step-num">2</div>
                <div class="step-text">
                    <strong>Ajustar c√°mara nativa</strong>
                    <span id="capStep2Text">
                        Abre la app de c√°mara del tel√©fono, modo Pro/Manual, pon el tiempo sugerido, ISO recomendado y enfoque en ‚àû.
                    </span>
                </div>
            </div>
            <div class="step">
                <div class="step-num">3</div>
                <div class="step-text">
                    <strong>Disparar secuencia</strong>
                    <span id="capStep3Text">
                        Usa temporizador de 3‚Äì5 s y toma el n√∫mero de fotos sugeridas para apilar despu√©s.
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- Panel Sesi√≥n -->
    <section class="panel" id="panelSession" style="display:none;">
        <div class="field-label">Resumen r√°pido de sesi√≥n</div>
        <div class="params">
            <div><strong>Objeto:</strong> <span id="sessionObject">V√≠a L√°ctea</span></div>
            <div><strong>Par√°metros usados (manual):</strong></div>
            <div id="sessionParamsText">
                ISO 1600, 15 s, 32 fotos, Bortle 5, tr√≠pode + temporizador.
            </div>
            <div style="margin-top:4px;">
                Calidad esperada: <span class="badge-ok" id="sessionQuality">Buena si apilas y editas el RAW/JPEG.</span>
            </div>
        </div>
        <div class="field" style="margin-top:6px;">
            <div class="field-label">Notas de la sesi√≥n (se guardan localmente)</div>
            <textarea id="sessionNotes" rows="4" style="width:100%;border-radius:10px;border:1px solid rgba(124,77,255,0.5);background:rgba(0,0,0,0.4);color:#fff;font-size:0.78rem;padding:6px;resize:vertical;"></textarea>
        </div>
    </section>
</main>

<footer class="footer">
    <button class="btn-secondary" id="btnStartCamera">Iniciar c√°mara</button>
    <button class="btn-primary" id="btnInstall">Instalar app</button>
</footer>

<script>
    // Ubicaciones con Bortle y ventanas aproximadas (simplificado)
    const locations = {
        pereira: {
            name: "Pereira",
            bortle: 6,
            milkywayWindow: "22:40‚Äì00:20",
            deepSkyWindow: "23:30‚Äì02:00"
        },
        cartago: {
            name: "Cartago",
            bortle: 5,
            milkywayWindow: "22:20‚Äì00:10",
            deepSkyWindow: "23:00‚Äì02:00"
        },
        obando: {
            name: "Obando",
            bortle: 4,
            milkywayWindow: "22:00‚Äì00:30",
            deepSkyWindow: "22:30‚Äì02:30"
        },
        juandiaz: {
            name: "Juan D√≠az (rural)",
            bortle: 3,
            milkywayWindow: "21:40‚Äì00:40",
            deepSkyWindow: "22:00‚Äì03:00"
        },
        barcelona: {
            name: "Barcelona",
            bortle: 7,
            milkywayWindow: "00:30‚Äì03:00 (solo zonas muy oscuras fuera de la ciudad)",
            deepSkyWindow: "01:00‚Äì03:30"
        },
        custom: {
            name: "Ubicaci√≥n personalizada",
            bortle: 5,
            milkywayWindow: "22:30‚Äì00:00",
            deepSkyWindow: "23:00‚Äì02:00"
        }
    };

    // Configuraciones por objeto
    const objectPresets = {
        milkyway: {
            name: "V√≠a L√°ctea (paisaje)",
            type: "Cielo profundo",
            bortleAdjust: true,
            paramsText: "ISO 1600‚Äì3200 ¬∑ 15‚Äì20 s ¬∑ f/1.65 (m√°xima apertura) ¬∑ 20‚Äì40 fotos para apilado.",
            captureText: "V√≠a L√°ctea ¬∑ Modo Pro ¬∑ ISO 1600‚Äì3200 ¬∑ 15‚Äì20 s ¬∑ enfoque manual a infinito.",
            steps: {
                s1: "Usa tr√≠pode, modo avi√≥n y brillo m√≠nimo. En tu Redmi, usa la c√°mara principal con la apertura m√°s luminosa.",
                s2: "Apunta hacia el sur/se-suroeste donde la banda de la V√≠a L√°ctea est√© m√°s alta, evitando luces directas.",
                s3: "Temporizador 3‚Äì5 s, 20‚Äì40 fotos para apilar luego en software."
            }
        },
        andromeda: {
            name: "Galaxia de Andr√≥meda (M31)",
            type: "Cielo profundo",
            bortleAdjust: true,
            paramsText: "ISO 3200‚Äì6400 ¬∑ 10‚Äì15 s ¬∑ f/1.65 ¬∑ m√≠nimo 40‚Äì80 fotos para apilado.",
            captureText: "Andr√≥meda ¬∑ Modo Pro ¬∑ ISO 3200‚Äì6400 ¬∑ 10‚Äì15 s ¬∑ muchas tomas.",
            steps: {
                s1: "Tr√≠pode estable, modo avi√≥n y sin vibraciones.",
                s2: "Localiza Andr√≥meda al NE/N y c√©ntrala con una app de planetario.",
                s3: "Dispara 40‚Äì80 fotos cortas para apilar y mejorar se√±al/ruido."
            }
        },
        orion: {
            name: "Nebulosa de Ori√≥n (M42)",
            type: "Cielo profundo",
            bortleAdjust: true,
            paramsText: "ISO 1600‚Äì3200 ¬∑ 5‚Äì10 s ¬∑ f/1.65 ¬∑ 30‚Äì60 fotos.",
            captureText: "Ori√≥n ¬∑ ISO 1600‚Äì3200 ¬∑ 5‚Äì10 s ¬∑ muchas tomas cortas.",
            steps: {
                s1: "Tr√≠pode, lente limpia y Ori√≥n alto en el cielo (medianoche‚Äìmadrugada).",
                s2: "Encuadra el cintur√≥n y baja un poco para incluir la nebulosa.",
                s3: "Toma 30‚Äì60 fotos para evitar quemar el n√∫cleo."
            }
        },
        pleiades: {
            name: "Pl√©yades (M45)",
            type: "Cielo profundo",
            bortleAdjust: true,
            paramsText: "ISO 1600‚Äì3200 ¬∑ 10‚Äì15 s ¬∑ f/1.65 ¬∑ 30‚Äì60 fotos.",
            captureText: "Pl√©yades ¬∑ ISO 1600‚Äì3200 ¬∑ 10‚Äì15 s ¬∑ prioriza muchas tomas.",
            steps: {
                s1: "Busca el c√∫mulo en un cielo lo m√°s oscuro posible (Bortle 3‚Äì4 ideal).",
                s2: "Centra el racimo de estrellas y enfoca a infinito.",
                s3: "Captura 30‚Äì60 fotos con temporizador para apilar."
            }
        },
        moon: {
            name: "Luna (detalles)",
            type: "Luna / planetas",
            bortleAdjust: false,
            paramsText: "ISO 100‚Äì400 ¬∑ 1/125‚Äì1/500 s ¬∑ f/1.65‚Äìf/2.4 ¬∑ 10‚Äì30 fotos.",
            captureText: "Luna ¬∑ ISO bajo ¬∑ 1/125‚Äì1/500 s ¬∑ evita sobreexponer.",
            steps: {
                s1: "Usa tr√≠pode o apoyo firme y desactiva estabilizaci√≥n en tr√≠pode.",
                s2: "Ampl√≠a con zoom √≥ptico/moderado o telescopio; enfoca en el terminador.",
                s3: "Haz varias fotos r√°pidas y elige la m√°s n√≠tida o ap√≠lalas."
            }
        },
        moonWide: {
            name: "Luna + paisaje",
            type: "Luna / paisaje",
            bortleAdjust: false,
            paramsText: "ISO 100‚Äì800 ¬∑ 1/4‚Äì1/30 s ¬∑ f/1.65 ¬∑ una buena foto equilibrada.",
            captureText: "Luna con paisaje ¬∑ equilibra exposici√≥n entre suelo y luna, quiz√° HDR.",
            steps: {
                s1: "Busca siluetas interesantes (√°rboles, montes, edificios).",
                s2: "Enfoca a la luna o infinito, ajusta hasta no quemarla.",
                s3: "Prueba varios tiempos y revisa que el suelo no quede totalmente negro."
            }
        },
        jupiter: {
            name: "J√∫piter",
            type: "Planeta",
            bortleAdjust: false,
            paramsText: "ISO 400‚Äì800 ¬∑ 1/15‚Äì1/60 s ¬∑ zoom moderado ¬∑ muchas tomas o v√≠deo.",
            captureText: "J√∫piter ¬∑ tiempos cortos, mejor con telescopio + adaptador.",
            steps: {
                s1: "Acopla el m√≥vil al ocular si tienes telescopio, o usa zoom √≥ptico suave.",
                s2: "Centra el planeta y afina enfoque viendo las bandas.",
                s3: "Captura muchas fotos o v√≠deo corto para apilar."
            }
        },
        saturn: {
            name: "Saturno",
            type: "Planeta",
            bortleAdjust: false,
            paramsText: "ISO 800‚Äì1600 ¬∑ 1/15‚Äì1/60 s ¬∑ telescopio recomendado.",
            captureText: "Saturno ¬∑ requiere mucha focal; m√≥vil + telescopio.",
            steps: {
                s1: "Usa adaptador firme al telescopio.",
                s2: "Enfoca hasta ver anillos bien definidos.",
                s3: "Graba v√≠deos o muchas fotos para apilar."
            }
        },
        mars: {
            name: "Marte",
            type: "Planeta",
            bortleAdjust: false,
            paramsText: "ISO 800‚Äì1600 ¬∑ 1/30‚Äì1/125 s ¬∑ telescopio preferible.",
            captureText: "Marte ¬∑ muy peque√±o, idealmente telescopio + apilado.",
            steps: {
                s1: "Telescopio con aumento moderado si es posible.",
                s2: "Centra el disco y busca el borde m√°s n√≠tido.",
                s3: "Muchas tomas r√°pidas para apilar."
            }
        }
    };

    // Tabs
    const tabPlan = document.getElementById('tabPlan');
    const tabCapture = document.getElementById('tabCapture');
    const tabSession = document.getElementById('tabSession');
    const panelPlan = document.getElementById('panelPlan');
    const panelCapture = document.getElementById('panelCapture');
    const panelSession = document.getElementById('panelSession');

    function setTab(tab) {
        [tabPlan, tabCapture, tabSession].forEach(t => t.classList.remove('active'));
        [panelPlan, panelCapture, panelSession].forEach(p => p.style.display = 'none');

        if (tab === 'plan') {
            tabPlan.classList.add('active');
            panelPlan.style.display = 'block';
        } else if (tab === 'capture') {
            tabCapture.classList.add('active');
            panelCapture.style.display = 'block';
        } else {
            tabSession.classList.add('active');
            panelSession.style.display = 'block';
        }
    }

    tabPlan.addEventListener('click', () => setTab('plan'));
    tabCapture.addEventListener('click', () => setTab('capture'));
    tabSession.addEventListener('click', () => setTab('session'));

    // Elementos
    const locationSelect = document.getElementById('locationSelect');
    const objectSelect = document.getElementById('objectSelect');
    const bortleSelect = document.getElementById('bortleSelect');
    const trailingInput = document.getElementById('trailingInput');
    const paramsText = document.getElementById('paramsText');
    const paramsCaptureText = document.getElementById('paramsCaptureText');
    const objectTypeTag = document.getElementById('objectTypeTag');
    const objectNameLabel = document.getElementById('objectNameLabel');
    const sessionObject = document.getElementById('sessionObject');
    const sessionParamsText = document.getElementById('sessionParamsText');

    const step1Text = document.getElementById('step1Text');
    const step2Text = document.getElementById('step2Text');
    const step3Text = document.getElementById('step3Text');
    const capStep1Text = document.getElementById('capStep1Text');
    const capStep2Text = document.getElementById('capStep2Text');
    const capStep3Text = document.getElementById('capStep3Text');

    const skyQualityTag = document.getElementById('skyQualityTag');
    const tonightSummary = document.getElementById('tonightSummary');
    const moonInfo = document.getElementById('moonInfo');
    const tonightTip = document.getElementById('tonightTip');
    const bestTimeLabel = document.getElementById('bestTimeLabel');
    const altitudeLabel = document.getElementById('altitudeLabel');

    // C√°mara
    const btnStartCamera = document.getElementById('btnStartCamera');
    const cameraStatus = document.getElementById('cameraStatus');
    const videoEl = document.getElementById('cameraVideo');
    let mediaStream = null;

    // Instalaci√≥n
    let deferredPrompt = null;
    const btnInstall = document.getElementById('btnInstall');

    // Red mode
    const redModeToggle = document.getElementById('redModeToggle');

    // Notas sesi√≥n
    const sessionNotes = document.getElementById('sessionNotes');

    function applyLocationBortleFromPreset() {
        const locKey = locationSelect.value;
        const loc = locations[locKey] || locations.pereira;
        // Solo cambiamos bortle autom√°ticamente si el usuario no ha tocado nada en esta sesi√≥n
        bortleSelect.value = loc.bortle.toString();
    }

    function updatePreset() {
        const locKey = locationSelect.value;
        const loc = locations[locKey] || locations.pereira;
        const key = objectSelect.value;
        const preset = objectPresets[key] || objectPresets.milkyway;
        const bortle = parseInt(bortleSelect.value || "5", 10);
        const trailing = parseInt(trailingInput.value || "5", 10);

        objectNameLabel.textContent = preset.name;
        objectTypeTag.textContent = preset.type;
        sessionObject.textContent = preset.name;

        let params = preset.paramsText;
        if (preset.bortleAdjust) {
            if (bortle >= 6) {
                params += " Cielo brillante: prioriza ISO alto y m√°s tomas para apilado.";
            } else if (bortle <= 4) {
                params += " Cielo oscuro: puedes bajar algo el ISO para menos ruido.";
            }
        }
        params += ` Tolerancia trailing: ${trailing}%.`;
        paramsText.textContent = params;
        paramsCaptureText.textContent = preset.captureText + ` Tolerancia trailing: ${trailing}%.`;
        sessionParamsText.textContent = params;

        // Ventanas aproximadas seg√∫n lugar + tipo de objeto
        if (key === "milkyway") {
            tonightSummary.textContent = `Ventana V√≠a L√°ctea: ${loc.milkywayWindow}.`;
            bestTimeLabel.textContent = loc.milkywayWindow;
            altitudeLabel.textContent = "+40‚Äì60¬∞ hacia el sur (aprox.)";
            tonightTip.textContent = "Busca el sector m√°s oscuro hacia el sur y haz muchas tomas para apilar.";
        } else if (preset.type === "Cielo profundo") {
            tonightSummary.textContent = `Ventana cielo profundo: ${loc.deepSkyWindow}.`;
            bestTimeLabel.textContent = loc.deepSkyWindow;
            altitudeLabel.textContent = "M√°s alto cerca del meridiano (medianoche local).";
            tonightTip.textContent = "Mientras m√°s alto est√© el objeto y m√°s oscuro el cielo, mejor detalle.";
        } else if (key === "moon" || key === "moonWide") {
            tonightSummary.textContent = "Luna visible gran parte de la noche; prioriza el terminador.";
            bestTimeLabel.textContent = "2‚Äì3 h despu√©s de salida o antes de puesta.";
            altitudeLabel.textContent = "40‚Äì70¬∞ (seg√∫n hora).";
            tonightTip.textContent = "Mejor relieve cuando la Luna no est√° llena y ves sombras en el terminador.";
        } else {
            tonightSummary.textContent = "Planetas: mejor cuando est√©n altos sobre el horizonte.";
            bestTimeLabel.textContent = "Cerca del tr√°nsito (cuando culminan).";
            altitudeLabel.textContent = "Var√≠a seg√∫n fecha y lugar.";
            tonightTip.textContent = "Comprueba la altura del planeta en una app de planetario para la noche actual.";
        }

        // Bortle texto
        const bortleText = `Bortle ${bortle} aprox. (${loc.name})`;
        skyQualityTag.textContent = bortleText;
        if (bortle <= 4) {
            skyQualityTag.style.color = "#4caf50";
        } else if (bortle === 5) {
            skyQualityTag.style.color = "#ffc107";
        } else {
            skyQualityTag.style.color = "#ff5252";
        }

        // Pasos
        step1Text.textContent = preset.steps.s1;
        step2Text.textContent = preset.steps.s2;
        step3Text.textContent = preset.steps.s3;
        capStep1Text.textContent = preset.steps.s1;
        capStep2Text.textContent = preset.steps.s2;
        capStep3Text.textContent = preset.steps.s3;

        // Nota de Luna (simulada)
        if (key === "milkyway") {
            moonInfo.textContent = "Luna: ideal si est√° por debajo del horizonte o en fase fina.";
        } else if (key === "moon" || key === "moonWide") {
            moonInfo.textContent = "Para Luna, la contaminaci√≥n lum√≠nica afecta menos; importa m√°s la turbulencia.";
        } else {
            moonInfo.textContent = "Mejor con Luna baja o nueva para objetos d√©biles.";
        }

        // Guardar estado
        localStorage.setItem("astroplan:lastObject", key);
        localStorage.setItem("astroplan:lastBortle", bortle.toString());
        localStorage.setItem("astroplan:lastTrailing", trailing.toString());
        localStorage.setItem("astroplan:lastLocation", locKey);
    }

    // Eventos
    locationSelect.addEventListener('change', () => {
        const locKey = locationSelect.value;
        const loc = locations[locKey] || locations.pereira;
        // Aplicar Bortle sugerido al cambiar de ubicaci√≥n
        bortleSelect.value = loc.bortle.toString();
        updatePreset();
    });

    objectSelect.addEventListener('change', updatePreset);
    bortleSelect.addEventListener('change', updatePreset);
    trailingInput.addEventListener('change', updatePreset);

    sessionNotes.addEventListener('input', () => {
        localStorage.setItem("astroplan:sessionNotes", sessionNotes.value);
    });

    redModeToggle.addEventListener('click', () => {
        const on = !redModeToggle.classList.contains('on');
        redModeToggle.classList.toggle('on', on);
        document.body.style.filter = on ? "hue-rotate(-140deg) saturate(1.2)" : "none";
        localStorage.setItem("astroplan:redMode", on ? "1" : "0");
    });

    async function startCamera() {
        try {
            if (mediaStream) {
                mediaStream.getTracks().forEach(t => t.stop());
                mediaStream = null;
                videoEl.srcObject = null;
                cameraStatus.textContent = "C√°mara detenida. Toca de nuevo para iniciar.";
                btnStartCamera.textContent = "Iniciar c√°mara";
                return;
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                cameraStatus.textContent = "Este navegador no permite usar la c√°mara desde la PWA.";
                return;
            }
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" },
                audio: false
            });
            videoEl.srcObject = mediaStream;
            cameraStatus.textContent = "Ajusta el encuadre aqu√≠ y luego dispara con la app de c√°mara nativa usando los par√°metros sugeridos.";
            btnStartCamera.textContent = "Detener c√°mara";
        } catch (err) {
            console.error(err);
            cameraStatus.textContent = "No se pudo acceder a la c√°mara. Revisa permisos del navegador.";
        }
    }

    btnStartCamera.addEventListener('click', () => {
        setTab('capture');
        startCamera();
    });

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        btnInstall.disabled = false;
    });

    btnInstall.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === "accepted") {
                btnInstall.textContent = "Instalada ‚úî";
            } else {
                btnInstall.textContent = "Instalar app";
            }
            deferredPrompt = null;
        } else {
            alert("Si no aparece el di√°logo, usa el men√∫ de Chrome ‚Üí \"Instalar app\" o \"A√±adir a pantalla\".");
        }
    });

    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("service-worker.js").catch(console.error);
        });
    }

    function restoreState() {
        const lastObj = localStorage.getItem("astroplan:lastObject");
        const lastBortle = localStorage.getItem("astroplan:lastBortle");
        const lastTrailing = localStorage.getItem("astroplan:lastTrailing");
        const notes = localStorage.getItem("astroplan:sessionNotes");
        const red = localStorage.getItem("astroplan:redMode");
        const lastLocation = localStorage.getItem("astroplan:lastLocation");

        if (lastLocation && locations[lastLocation]) {
            locationSelect.value = lastLocation;
        }
        // Aplica Bortle sugerido de la ubicaci√≥n restaurada
        applyLocationBortleFromPreset();

        if (lastObj && objectSelect.querySelector(`option[value="${lastObj}"]`)) {
            objectSelect.value = lastObj;
        }
        if (lastBortle) {
            bortleSelect.value = lastBortle;
        }
        if (lastTrailing) {
            trailingInput.value = lastTrailing;
        }
        if (notes) {
            sessionNotes.value = notes;
        }
        if (red === "1") {
            redModeToggle.classList.add('on');
            document.body.style.filter = "hue-rotate(-140deg) saturate(1.2)";
        }

        updatePreset();
    }

    restoreState();
</script>
</body>
</html>
